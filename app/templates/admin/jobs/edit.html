{% extends "admin/layout.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">‚úçÔ∏è S·ª≠a Tin Tuy·ªÉn D·ª•ng: {{ job.title }}</h1>
    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="POST" id="jobForm">
                
                <div class="mb-3">
                    <label for="title"><strong>Ti√™u ƒë·ªÅ v·ªã tr√≠</strong> <span class="text-danger">*</span></label>
                    <input type="text" id="title" name="title" class="form-control" value="{{ job.title }}" required placeholder="V√≠ d·ª•: L·∫≠p tr√¨nh vi√™n Backend (Python/Django)">
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="salary_range">M·ª©c l∆∞∆°ng d·ª± ki·∫øn</label>
                        <input type="text" id="salary_range" name="salary_range" class="form-control" value="{{ job.salary_range }}" placeholder="V√≠ d·ª•: 15 - 25 Tri·ªáu VND">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="location">ƒê·ªãa ƒëi·ªÉm l√†m vi·ªác</label>
                        <input type="text" id="location" name="location" class="form-control" value="{{ job.location }}" placeholder="V√≠ d·ª•: Qu·∫≠n 1, TP. H·ªì Ch√≠ Minh">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="job_type">Lo·∫°i h√¨nh c√¥ng vi·ªác</label>
                        <input type="text" id="job_type" name="job_type" class="form-control" value="{{ job.job_type or '' }}" placeholder="V√≠ d·ª•: Full-time">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="vacancy">S·ªë l∆∞·ª£ng tuy·ªÉn</label>
                        <input type="number" id="vacancy" name="vacancy" class="form-control" min="1" value="{{ job.vacancy or 1 }}" placeholder="1">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="deadline">H·∫°n n·ªôp h·ªì s∆°</label>
                        <input type="date" id="deadline" name="deadline" class="form-control" value="{{ job.deadline.strftime('%Y-%m-%d') if job.deadline else '' }}">
                    </div>
                </div>
                
                <hr>

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="description"><strong>M√¥ t·∫£ c√¥ng vi·ªác</strong> <span class="text-danger">*</span></label>
                            <textarea id="description" name="description_editor" class="form-control" rows="8" required placeholder="Chi ti·∫øt c√¥ng vi·ªác v√† m√¥i tr∆∞·ªùng l√†m vi·ªác...">{{ job.description }}</textarea>
                            
                            <textarea class="d-none" name="description" id="te1"></textarea> 
                        </div>
                        <div class="mb-3">
                            <label for="responsibilities">Tr√°ch nhi·ªám ch√≠nh</label>
                            <textarea id="responsibilities" name="responsibilities_editor" class="form-control" rows="4" placeholder="Li·ªát k√™ c√°c ƒë·∫ßu vi·ªác ch√≠nh (m·ªói m·ª•c m·ªôt d√≤ng)...">{{ job.responsibilities or '' }}</textarea>
                            <textarea class="d-none" name="responsibilities" id="te2"></textarea> 
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="requirements">Y√™u c·∫ßu ·ª©ng vi√™n</label>
                            <textarea id="requirements" name="requirements_editor" class="form-control" rows="4" placeholder="K·ªπ nƒÉng, kinh nghi·ªám b·∫Øt bu·ªôc...">{{ job.requirements or '' }}</textarea>
                            <textarea class="d-none" name="requirements" id="te3"></textarea> 
                        </div>
                        <div class="mb-3">
                            <label for="benefits">Ph√∫c l·ª£i / Quy·ªÅn l·ª£i</label>
                            <textarea id="benefits" name="benefits_editor" class="form-control" rows="4" placeholder="L∆∞∆°ng th√°ng 13, b·∫£o hi·ªÉm, du l·ªãch...">{{ job.benefits or '' }}</textarea>
                            <textarea class="d-none" name="benefits" id="te4"></textarea> 
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    
                    <div class="col-md-6 mb-3">
                        <label for="duration_days">Th·ªùi h·∫°n ƒëƒÉng tin (Ng√†y)</label>
                        <input type="number" id="duration_days" name="duration_days" class="form-control" min="1" value="{{ job.details.duration_days if job.details else 30 }}">
                    </div>
                </div>

                <div class="mt-4 pt-2 border-top">
                    <button type="button" class="btn btn-success btn-lg" onclick="onsubmitForm()">üíæ C·∫≠p Nh·∫≠t Tin Tuy·ªÉn D·ª•ng</button>
                    <a href="{{ url_for('admin.job_list') }}" class="btn btn-secondary btn-lg ml-2">H·ªßy B·ªè</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.ckeditor.com/ckeditor5/41.2.1/classic/ckeditor.js"></script>
<script>
    const editors = {}; 

    document.addEventListener('DOMContentLoaded', function() {
        // NOTE: ƒê·∫£m b·∫£o ID trong m·∫£ng n√†y kh·ªõp v·ªõi ID c·ªßa c√°c textarea (description, responsibilities, ...)
        const editorFields = ['#description', '#responsibilities', '#requirements', '#benefits'];

        editorFields.forEach(id => {
            const element = document.querySelector(id);
            if (element) {
                ClassicEditor.create(element)
                    .then(editor => {
                        const fieldName = id.substring(1); 
                        editors[fieldName] = editor; 
                        console.log(`CKEditor cho ${fieldName} ƒë√£ s·∫µn s√†ng.`);
                    })
                    .catch(error => console.error('L·ªói kh·ªüi t·∫°o CKEditor:', id, error));
            } else {
                console.warn('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ cho CKEditor:', id);
            }
        });
    });
    
    // H√†m l·∫•y n·ªôi dung HTML
    function getEditorContent(fieldName) {
        if (editors[fieldName]) {
            return editors[fieldName].getData(); 
        }
        return null;
    }

    // H√†m x·ª≠ l√Ω s·ª± ki·ªán submit form
    function onsubmitForm() {
        // 1. L·∫•y d·ªØ li·ªáu HTML t·ª´ CKEditor
        const descriptionHTML = getEditorContent('description');
        const responsibilitiesHTML = getEditorContent('responsibilities');
        const requirementsHTML = getEditorContent('requirements');
        const benefitsHTML = getEditorContent('benefits');

        // 2. ƒê·ªìng b·ªô d·ªØ li·ªáu v√†o c√°c tr∆∞·ªùng ·∫©n (c√≥ thu·ªôc t√≠nh name)
        // D√πng || '' ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªã l·ªói n·∫øu n·ªôi dung l√† null/undefined
        document.getElementById('te1').value = descriptionHTML || '';
        document.getElementById('te2').value = responsibilitiesHTML || '';
        document.getElementById('te3').value = requirementsHTML || '';
        document.getElementById('te4').value = benefitsHTML || '';
        
        // 3. ƒê·∫£m b·∫£o M√¥ t·∫£ c√¥ng vi·ªác kh√¥ng tr·ªëng tr∆∞·ªõc khi g·ª≠i
        if (!descriptionHTML || descriptionHTML.trim() === '' || descriptionHTML.trim() === '<p></p>') {
            alert('Vui l√≤ng nh·∫≠p M√¥ t·∫£ c√¥ng vi·ªác.');
            return; 
        }

        // 4. G·ª≠i form
        document.getElementById('jobForm').submit();
    }
</script>

{% endblock %}